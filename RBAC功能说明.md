# RBAC权限控制功能说明

## 📋 功能概述

系统已实现完整的基于角色的访问控制（RBAC），不同角色的用户拥有不同的权限。

## 🎭 角色定义

### 1. 超级管理员（role_id=1）
**拥有所有权限（19个）：**
- 用户管理：查看、创建、编辑、删除、导入、导出
- 角色管理：查看、创建、编辑、删除
- 权限管理：查看、分配
- 系统设置：查看、修改
- 访问统计：查看、导出
- Emby同步：查看、执行、配置

### 2. 普通管理员（role_id=2）
**拥有8个权限：**
- ✅ 用户管理：查看、创建、编辑、删除
- ✅ 访问统计：查看、导出
- ✅ Emby同步：查看、执行
- ❌ 系统设置：无权限
- ❌ 角色管理：无权限
- ❌ 权限管理：无权限

### 3. 访客管理员（role_id=3）
**拥有6个权限（仅查看）：**
- ✅ 用户管理：查看
- ✅ 角色管理：查看
- ✅ 权限管理：查看
- ✅ 系统设置：查看
- ✅ 访问统计：查看
- ✅ Emby同步：查看
- ❌ 所有修改操作：无权限

## 🔐 权限控制实现

### 后端权限控制
已实现：
- ✅ JWT Token验证
- ✅ 权限中间件（PermissionMiddleware）
- ✅ API路由权限保护
- ✅ 403权限不足响应

示例：
```go
// 需要user:create权限才能访问
users.POST("", middleware.PermissionMiddleware("user:create"), userHandler.Create)
```

### 前端权限控制
已创建工具：
- ✅ usePermission Hook（权限检查）
- ✅ PermissionGuard组件（页面/组件保护）
- ✅ 动态菜单（根据权限显示）

使用方法：
```typescript
// 1. 使用Hook检查权限
const { hasPermission } = usePermission();

// 2. 条件渲染按钮
{hasPermission('user:create') && (
  <Button onClick={handleCreate}>新建用户</Button>
)}

// 3. 使用权限守卫保护整个页面
<PermissionGuard permission="user:view">
  <UserListContent />
</PermissionGuard>
```

## 📊 测试结果

### 超级管理员（admin）
```bash
✅ 访问用户列表：成功
✅ 访问角色列表：成功
✅ 访问系统配置：成功
```

### 普通管理员（newuser）
```bash
✅ 访问用户列表：成功
✅ 访问统计数据：成功
❌ 访问系统配置：403权限不足
```

## 🚀 使用指南

### 1. 测试不同角色

**超级管理员登录：**
- 用户名：`admin`
- 密码：`Liubei00`
- 权限：全部19个

**普通管理员登录：**
- 用户名：`newuser`
- 密码：`newpass123`
- 权限：8个

### 2. 注册新用户
- 访问：http://localhost:3000/register
- 新注册用户默认分配"普通管理员"角色（role_id=2）
- 自动在Emby服务器创建同名账号

### 3. 修改用户角色
超级管理员可以在用户管理页面修改用户的角色：
1. 进入"用户管理"
2. 点击"编辑"
3. 修改"角色"字段
4. 保存

## 🎯 权限矩阵

| 功能模块 | 超级管理员 | 普通管理员 | 访客管理员 |
|---------|-----------|-----------|-----------|
| 用户管理-查看 | ✅ | ✅ | ✅ |
| 用户管理-创建 | ✅ | ✅ | ❌ |
| 用户管理-编辑 | ✅ | ✅ | ❌ |
| 用户管理-删除 | ✅ | ✅ | ❌ |
| 角色管理-查看 | ✅ | ❌ | ✅ |
| 角色管理-编辑 | ✅ | ❌ | ❌ |
| 权限管理-查看 | ✅ | ❌ | ✅ |
| 权限管理-分配 | ✅ | ❌ | ❌ |
| 系统配置-查看 | ✅ | ❌ | ✅ |
| 系统配置-修改 | ✅ | ❌ | ❌ |
| 访问统计-查看 | ✅ | ✅ | ✅ |
| 访问统计-导出 | ✅ | ✅ | ❌ |
| Emby同步-查看 | ✅ | ✅ | ✅ |
| Emby同步-执行 | ✅ | ✅ | ❌ |
| Emby同步-配置 | ✅ | ❌ | ❌ |

## 💡 安全建议

1. **最小权限原则**：给用户分配完成工作所需的最小权限集
2. **定期审查**：定期检查用户权限，撤销不必要的权限
3. **权限分离**：避免将所有权限集中在少数账号
4. **审计日志**：所有操作都会记录在访问记录中

## 🧪 测试脚本

运行完整的RBAC测试：
```bash
./test_rbac.sh
```

## 📝 下一步优化

- [ ] 完善前端权限UI（已创建工具，待应用到所有页面）
- [ ] 添加权限变更审计
- [ ] 实现细粒度权限（如：只能编辑自己创建的用户）
- [ ] 添加权限继承机制
- [ ] 实现临时权限授予
