# Emby用户管理系统 - 开发方案

## 一、项目概述

### 1.1 项目目标
构建一套专为 Emby 媒体服务器设计的用户管理系统，实现用户账号集中管控、权限分配、访问行为追踪，并对接 Emby 原生 API 实现数据同步。

### 1.2 技术选型

#### 1.2.1 前端技术栈（React）

| 技术 | 版本 | 说明 |
|------|------|------|
| React | 18+ | 核心框架 |
| TypeScript | 5.0+ | 强类型约束 |
| Ant Design | 5.x | UI 组件库，统一视觉风格 |
| Redux Toolkit | Latest | 全局状态管理 |
| React Context | - | 局部状态管理 |
| React Router | 6.x | 路由管理（路由守卫、嵌套路由） |
| Axios | Latest | 网络请求（拦截器、错误处理） |
| Chart.js | Latest | 数据可视化 |
| ESLint | Latest | 代码校验 |
| Prettier | Latest | 代码格式化 |
| Vite | Latest | 构建工具（快速构建、热更新） |

#### 1.2.2 后端技术栈（Go）

| 技术 | 版本 | 说明 |
|------|------|------|
| Go | 1.21+ | 编程语言 |
| Gin | 1.9+ | Web 框架（路由、中间件） |
| GORM | 2.x | PostgreSQL ORM |
| go-redis | 9.x | Redis 客户端（缓存、Token 存储） |
| golang-jwt/jwt | v5 | JWT 认证 |
| go-playground/validator | Latest | 请求参数校验 |
| zap | Latest | 结构化日志 |
| bcrypt | Latest | 密码加密 |
| Go Modules | - | 依赖管理 |

#### 1.2.3 数据存储

| 技术 | 版本 | 说明 |
|------|------|------|
| PostgreSQL | 14+ | 主数据库（用户、角色、权限、访问记录） |
| Redis | 7.0+ | 缓存（热点数据、JWT Token、权限缓存、限流） |

#### 1.2.4 部署与运维

| 技术 | 版本 | 说明 |
|------|------|------|
| Docker | Latest | 容器化 |
| Docker Compose | Latest | 容器编排 |
| Nginx | Latest | 反向代理、静态资源服务 |

---

## 二、系统架构

### 2.1 整体架构
```
┌─────────────────────────────────────────────────────────┐
│                     前端 (React)                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│  │  登录页   │ │ 用户管理  │ │ 角色管理  │ │ Emby同步  │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │
└─────────────────────────────────────────────────────────┘
                           │ HTTP/REST
                           ▼
┌─────────────────────────────────────────────────────────┐
│                     后端 (Go/Gin)                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│  │  Router  │ │ Handler  │ │ Service  │ │   DAO    │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │
└─────────────────────────────────────────────────────────┘
                           │
          ┌────────────────┼────────────────┐
          ▼                ▼                ▼
   ┌────────────┐   ┌────────────┐   ┌────────────┐
   │ PostgreSQL │   │   Redis    │   │ Emby Server│
   └────────────┘   └────────────┘   └────────────┘
```

### 2.2 目录结构
```
embyhub/
├── backend/              # 后端服务
│   ├── cmd/             # 程序入口
│   ├── config/          # 配置管理
│   ├── internal/        # 内部代码
│   │   ├── dao/        # 数据访问层
│   │   ├── handler/    # 控制器层
│   │   ├── middleware/ # 中间件
│   │   ├── model/      # 数据模型
│   │   ├── router/     # 路由配置
│   │   ├── service/    # 业务逻辑层
│   │   └── util/       # 工具函数
│   └── pkg/            # 公共包
├── frontend/            # 前端应用
│   └── src/
│       ├── api/        # API接口
│       ├── components/ # 公共组件
│       ├── pages/      # 页面组件
│       ├── store/      # Redux状态
│       ├── types/      # 类型定义
│       └── utils/      # 工具函数
├── database/            # 数据库脚本
└── docker-compose.yml   # Docker编排
```

---

## 三、功能模块设计

### 3.1 核心功能模块

| 模块 | 功能描述 | 优先级 |
|------|----------|--------|
| 认证模块 | 管理员登录、登出、Token 刷新 | P0 |
| 用户管理 | 用户 CRUD、批量操作、密码重置 | P0 |
| 角色管理 | 角色 CRUD、权限分配 | P0 |
| 权限管理 | 权限列表查询 | P1 |
| Emby同步 | 连接测试、用户同步、状态同步 | P1 |
| 访问统计 | 访问记录、数据统计、可视化 | P2 |
| 系统配置 | 配置管理、Emby 连接配置 | P1 |

### 3.2 API 设计

#### 3.2.1 认证接口
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/auth/login | 管理员登录 |
| POST | /api/auth/logout | 管理员登出 |
| GET | /api/auth/current | 获取当前用户 |

#### 3.2.2 用户管理接口
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/users | 获取用户列表（分页） |
| POST | /api/users | 创建用户 |
| GET | /api/users/:id | 获取用户详情 |
| PUT | /api/users/:id | 更新用户 |
| DELETE | /api/users/:id | 删除用户 |
| PUT | /api/users/:id/password | 重置密码 |

#### 3.2.3 角色管理接口
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/roles | 获取角色列表 |
| POST | /api/roles | 创建角色 |
| PUT | /api/roles/:id | 更新角色 |
| DELETE | /api/roles/:id | 删除角色 |
| POST | /api/roles/:id/permissions | 分配权限 |

#### 3.2.4 Emby同步接口
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/emby/test | 测试连接 |
| POST | /api/emby/sync | 同步用户 |
| GET | /api/emby/users | 获取Emby用户 |

---

## 四、数据库设计

### 4.1 ER 图
```
┌────────────┐       ┌─────────────────┐       ┌──────────────┐
│   roles    │◄──────│ role_permissions │──────►│ permissions  │
└────────────┘       └─────────────────┘       └──────────────┘
      ▲
      │
┌─────┴──────┐       ┌────────────────┐
│   users    │◄──────│ access_records │
└────────────┘       └────────────────┘

┌────────────────┐
│ system_configs │
└────────────────┘
```

### 4.2 表结构

- **roles** - 角色表：存储系统角色信息
- **permissions** - 权限表：存储权限定义
- **role_permissions** - 角色权限关联表：多对多关系
- **users** - 用户表：存储用户信息及 Emby 用户 ID 映射
- **access_records** - 访问记录表：存储用户访问日志
- **system_configs** - 系统配置表：存储系统级配置

---

## 五、开发规范

### 5.1 后端代码规范

- 遵循 Go 官方代码规范
- 使用 `gofmt` 格式化代码
- 分层架构：Handler → Service → DAO
- 统一错误处理和响应格式
- 使用 Zap 进行日志记录

### 5.2 前端代码规范

- 所有注释、UI 文本使用中文
- 遵循 ESLint + Prettier 规范
- 组件使用函数式组件 + Hooks
- 状态管理使用 Redux Toolkit
- 使用 TypeScript 严格类型检查

### 5.3 Git 提交规范

```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 代码重构
test: 测试相关
chore: 构建/工具相关
```

---

## 六、部署方案

### 6.1 Docker Compose 部署（推荐）

```bash
# 一键启动所有服务
docker-compose up -d
```

服务端口：
- 前端: http://localhost:3000
- 后端: http://localhost:8080
- PostgreSQL: localhost:5432
- Redis: localhost:6379

### 6.2 手动部署

1. 启动 PostgreSQL 和 Redis
2. 初始化数据库脚本
3. 编译运行后端服务
4. 编译部署前端静态文件

---

## 七、测试策略

| 测试类型 | 工具 | 覆盖范围 |
|----------|------|----------|
| 单元测试 | Go testing | 后端 Service/DAO |
| 接口测试 | Postman/curl | API 接口 |
| 前端测试 | Jest + RTL | 组件测试 |
| E2E测试 | Cypress（可选） | 端到端流程 |

---

## 八、安全设计

- **认证**: JWT Token 认证，支持 Token 刷新
- **密码**: bcrypt 加密存储
- **权限**: 基于角色的访问控制（RBAC）
- **SQL注入**: GORM 参数化查询
- **XSS防护**: 前端输入校验 + 输出转义
- **CORS**: 配置允许的跨域源

---

## 九、性能优化

- **缓存**: Redis 缓存热点数据（用户信息、权限列表）
- **索引**: 数据库关键字段添加索引
- **分页**: 列表查询支持分页
- **懒加载**: 前端路由懒加载
- **Gzip**: Nginx 开启 Gzip 压缩

---

## 十、风险与应对

| 风险 | 应对措施 |
|------|----------|
| Emby API 变更 | 封装 Emby 客户端，便于适配 |
| 数据同步冲突 | 以 Emby 为主，本地增量更新 |
| 性能瓶颈 | 引入缓存、优化查询 |
| 安全漏洞 | 定期安全审计、依赖更新 |
